/* --------------------
   Case Study Questions
   --------------------*/

-- 1. What is the total amount each customer spent at the restaurant?
-- 2. How many days has each customer visited the restaurant?
-- 3. What was the first item from the menu purchased by each customer?
-- 4. What is the most purchased item on the menu and how many times was it purchased by all customers?
-- 5. Which item was the most popular for each customer?
-- 6. Which item was purchased first by the customer after they became a member?
-- 7. Which item was purchased just before the customer became a member?
-- 8. What is the total items and amount spent for each member before they became a member?
-- 9.  If each $1 spent equates to 10 points and sushi has a 2x points multiplier - how many points would each customer have?
-- 10. In the first week after a customer joins the program (including their join date) they earn 2x points on all items, not just sushi - how many points do customer A and B have at the end of January?

-- Example Query:
-- 1. What is the total amount each customer spent at the restaurant?

select customer_id,sum(price)
from sales as s
inner join menu as m
on m.product_id = s.product_id
group by customer_id
order by 2 desc;

-- 2. How many days has each customer visited the restaurant?

select customer_id, count(distinct order_date)
from sales
group by customer_id
order by 2 desc;

-- 3. What was the first item from the menu purchased by each customer?

with customer_first_purchase as
(select customer_id,product_name,
row_number() over( partition by customer_id order by order_date)  RN
from sales as s
inner join menu as mm
on s.product_id = mm.product_id)
select customer_id, product_name
from customer_first_purchase
where RN = 1;

-- 4. What is the most purchased item on the menu and how many times was it purchased by all customers?

select mm.product_name,count(s.product_id)
from sales as s
inner join menu as mm
on mm.product_id = s.product_id
group by mm.product_name
order by 2 desc
limit 1;
 
-- 5. Which item was the most popular for each customer?

with customer_top_choice as
(with total_product_wise_purcahse as 
(select s.customer_id,mm.product_name,count(mm.product_name) as prod_purchase_count
from sales as s
inner join menu as mm
on mm.product_id=s.product_id
group by mm.product_name,s.customer_id)
select customer_id,product_name, prod_purchase_count,
rank() over(partition by customer_id order by prod_purchase_count desc) as rk
from total_product_wise_purcahse)
select customer_id,product_name, prod_purchase_count from customer_top_choice
where rk = 1;

-- 6. Which item was purchased first by the customer after they became a member?

with first_order_after_member as
(select s.customer_id,s.order_date,me.product_name,mm.join_date,
rank() over( partition by s.customer_id order by s.order_date) as rk
from sales as s
inner join members as mm
on mm.customer_id = s.customer_id
inner join menu as me
on s.product_id = me.product_id
where s.order_date >= mm.join_date)
select customer_id,order_date,join_date,product_name
from first_order_after_member
where rk = 1;

-- 7. Which item was purchased just before the customer became a member?

with first_order_after_member as
(select s.customer_id,s.order_date,me.product_name,mm.join_date,
rank() over( partition by s.customer_id order by s.order_date) as rk
from sales as s
inner join members as mm
on mm.customer_id = s.customer_id
inner join menu as me
on s.product_id = me.product_id
where s.order_date < mm.join_date)
select customer_id,order_date,join_date,product_name
from first_order_after_member
where rk = 1;

-- 8. What is the total items and amount spent for each member before they became a member?

select s.customer_id,count(s.product_id),sum(me.price)
from sales as s
inner join menu as me
on me.product_id = s.product_id
inner join members as mm
on s.customer_id = mm.customer_id
where s.order_date < mm.join_date
group by s.customer_id
order by 1 ;


-- 9.  If each $1 spent equates to 10 points and sushi has a 2x points multiplier - how many points would each customer have?

with customer_points as
(select s.customer_id,
case
	when me.product_name = 'sushi' then me.price*20 else me.price*10
end as points_earned
from sales as s
inner join menu as me
on me.product_id = s.product_id)
select customer_id,sum(points_earned)
from customer_points
group by customer_id
order by 1;

-- 10. In the first week after a customer joins the program (including their join date) they earn 2x points on all items, not just sushi - how many points do customer A and B have at the end of January?

with intital_offered_points as 
(select s.customer_id,
case
	when s.order_date < mm.join_date then
 		case 
 			when me.product_name = 'suhsi' then me.price * 20 
 			else me.price * 10
 		end
 	when s.order_date >= (mm.join_date + interval '6days')  then
 		case 
 			when me.product_name = 'sushi' then me.price * 20 else me.price * 10
 		end
 	else me.price*20 
end points_earned
from sales as s
inner join  menu as me
on me.product_id = s.product_id
inner join members as mm
on mm.customer_id = s.customer_id
where s.order_date <= '2025-01-31')
select customer_id,sum(points_earned)
from intital_offered_points
group by customer_id
